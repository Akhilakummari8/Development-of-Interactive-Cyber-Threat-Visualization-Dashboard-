import sqlite3
import pandas as pd

# Create SQLite database
conn = sqlite3.connect("cyber_threat_dashboard.db")
# Enable foreign keys
conn.execute("PRAGMA foreign_keys = ON;")
cursor = conn.cursor()
print("Database connected successfully")

cursor.executescript("""
CREATE TABLE IF NOT EXISTS attack_types (
    attack_type_id INTEGER PRIMARY KEY AUTOINCREMENT,
    attack_name TEXT UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS severity_levels (
    severity_id INTEGER PRIMARY KEY AUTOINCREMENT,
    severity_score INTEGER CHECK (severity_score BETWEEN 1 AND 10),
    risk_level TEXT
);

CREATE TABLE IF NOT EXISTS mitre_techniques (
    mitre_id INTEGER PRIMARY KEY AUTOINCREMENT,
    technique_code TEXT UNIQUE NOT NULL,
    description TEXT
);

CREATE TABLE IF NOT EXISTS countries (
    country_id INTEGER PRIMARY KEY AUTOINCREMENT,
    country_name TEXT UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS incident_status (
    status_id INTEGER PRIMARY KEY AUTOINCREMENT,
    status_name TEXT UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS source_ips (
    ip_id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip_address TEXT UNIQUE NOT NULL,
    country_id INTEGER,
    FOREIGN KEY (country_id) REFERENCES countries(country_id)
);

CREATE TABLE IF NOT EXISTS destination_systems (
    destination_id INTEGER PRIMARY KEY AUTOINCREMENT,
    destination_ip TEXT UNIQUE NOT NULL
);
CREATE TABLE IF NOT EXISTS incidents (
    incident_id TEXT PRIMARY KEY,
    incident_time TEXT NOT NULL,
    attack_type_id INTEGER,
    severity_id INTEGER,
    ip_id INTEGER,
    destination_id INTEGER,
    mitre_id INTEGER,
    status_id INTEGER,
    FOREIGN KEY (attack_type_id) REFERENCES attack_types(attack_type_id),
    FOREIGN KEY (severity_id) REFERENCES severity_levels(severity_id),
    FOREIGN KEY (ip_id) REFERENCES source_ips(ip_id),
    FOREIGN KEY (destination_id) REFERENCES destination_systems(destination_id),
    FOREIGN KEY (mitre_id) REFERENCES mitre_techniques(mitre_id),
    FOREIGN KEY (status_id) REFERENCES incident_status(status_id)
);
""")
print("Tables created successfully")

cursor.executescript("""
INSERT OR IGNORE INTO attack_types (attack_name) VALUES
('Phishing'),('Malware'),('DDoS'),('Brute Force'),('Insider Threat'),('Ransomware');
INSERT OR IGNORE INTO severity_levels (severity_score, risk_level) VALUES
(1,'Low'),(2,'Low'),(3,'Low'),
(4,'Medium'),(5,'Medium'),(6,'Medium'),
(7,'High'),(8,'High'),(9,'Critical'),(10,'Critical');
INSERT OR IGNORE INTO mitre_techniques (technique_code, description) VALUES
('T1566','Phishing'),
('T1059','Command and Scripting Interpreter'),
('T1499','Denial of Service'),
('T1110','Brute Force'),
('T1081','Credential Access'),
('T1204','User Execution'),
('T1055','Process Injection');
INSERT OR IGNORE INTO countries (country_name) VALUES
('India'),('USA'),('China'),('Russia'),('Germany'),
('France'),('UK'),('Japan'),('Brazil'),('Canada');
INSERT OR IGNORE INTO incident_status (status_name) VALUES
('Open'),('Resolved'),('Investigating');
""")
conn.commit()
print("Master data inserted")

cursor.executescript("""
INSERT OR IGNORE INTO source_ips (ip_address, country_id) VALUES
('192.168.1.10',1),
('45.33.12.9',2),
('103.21.45.77',3);
INSERT OR IGNORE INTO destination_systems (destination_ip) VALUES
('10.0.0.5'),
('10.0.0.8'),
('10.0.0.2');
INSERT OR IGNORE INTO incidents VALUES
('INC00001','2024-04-22 20:26:00',3,8,1,1,6,3),
('INC00002','2024-05-10 11:45:00',1,6,2,2,1,2),
('INC00003','2024-06-15 14:10:00',2,9,3,3,7,1);
""")
conn.commit()
print("Sample incidents inserted")

query = """
SELECT a.attack_name, COUNT(*) AS total_attacks
FROM incidents i
JOIN attack_types a ON i.attack_type_id = a.attack_type_id
GROUP BY a.attack_name;
"""
df = pd.read_sql_query(query, conn)
df

query = """
SELECT i.incident_id, s.severity_score, s.risk_level
FROM incidents i
JOIN severity_levels s ON i.severity_id = s.severity_id
WHERE s.severity_score >= 8;
"""
pd.read_sql_query(query, conn)

query = """
SELECT c.country_name, COUNT(*) AS attack_count
FROM incidents i
JOIN source_ips si ON i.ip_id = si.ip_id
JOIN countries c ON si.country_id = c.country_id
GROUP BY c.country_name;
"""
pd.read_sql_query(query, conn)

conn.close()
print("Database connection closed")


